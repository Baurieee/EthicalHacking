# Windows Post-Exploitation and Lateral Movement and Token Abuse and SMB Hash Capture 
## What this is 

After initial exploitation, Meterpreter is used for **post-exploitation** (process migration, keylogging, command execution), then **lateral movement** using SMB (PSExec) and credential material (hashdump / pass-the-hash). Token impersonation (Incognito) is used to act as another logged-on user (especially domain users). Another technique is forcing SMB authentication to capture NTLM hashes via a fake SMB server. 

---

## What to monitor on Windows

### 1) Meterpreter/session behavior

Common host indicators:

* suspicious processes or injected threads (often starts in `svchost.exe`, then migrates to `explorer.exe`) 
* frequent process access events (injection/migration)
* new outbound connection to attacker host (reverse session)

Telemetry that helps:

* **Sysmon** (best): Event ID 1 (Process Create), 3 (Network), 10 (ProcessAccess), 7 (ImageLoad)
* Windows Security log: 4688 (process creation), 4624 (logon), 4672 (special privileges)

### 2) Keylogging

Keylogging via Meterpreter is not "one Windows log entry", but it usually needs:

* running inside `explorer.exe` (user context) and process migration events 
  Detection is mostly behavioral:
* unexpected process injection into `explorer.exe`
* unknown remote session + user activity capture
* correlation with other Meterpreter indicators (network + injection)

### 3) Hash dumping (Credential Access)

Indicators:

* access to LSASS/SAM related data
* suspicious use of credential dumping techniques after SYSTEM access (`hashdump`) 
  Look for:
* abnormal access to sensitive processes (Sysmon 10)
* security log alerts related to credential dumping (if rules exist)
* follow-up lateral movement attempts right after

### 4) Lateral movement with PSExec / SMB

Indicators on the **target** machine of PSExec:

* service creation / remote execution patterns (commonly a temporary service)
* SMB logons (type 3) from the pivot machine
* rapid remote admin activity after authentication 

Windows logs:

* 4624 (successful logon) + LogonType 3 (network)
* 7045 (new service installed) in System log (strong PSExec indicator)
* Sysmon 1 for the created service binary / execution chain

### 5) Token impersonation (Incognito)

Indicators:

* privilege use + token manipulation (hard to see without good telemetry)
* suspicious identity switching: actions performed "as another user" without interactive login 
  Best approach:
* correlate with process creation + logon events + unusual access patterns
* watch for actions by accounts that "shouldnâ€™t be active" on that host

### 6) Forcing SMB auth to capture NTLM hashes

Indicators on the Windows host:

* command `net use \\attacker\share` (process creation)
* outbound SMB session to a non-file-server IP (attacker) 

Indicators on the network:

* NTLM authentication attempts to an unexpected SMB server
* repeated SMB auth bursts (hash harvesting)


## whats suspicious

* `svchost.exe` -> `explorer.exe` migration patterns + outbound reverse connection (session control). 
* New Windows services (Event 7045) + network logons (4624 type 3) from a workstation = classic lateral movement. 
* `hashdump` activity followed by PSExec/pass-the-hash attempts = credential access -> movement chain. 
* `net use \\attacker\share` style connections = forced SMB auth, often used to capture NTLM hashes. 
